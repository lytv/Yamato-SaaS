# Production Step Excel Export Feature Implementation Plan

## Overview
Implement Excel export functionality for Production Steps following the exact same patterns as the existing Product Export feature. Users can export their production steps list (respecting current search/filter/sort context) as a well-formatted Excel file (.xlsx format).

## Architecture Integration Points
- **Reuses existing patterns**: Follows exact same structure as `/api/products/export`
- **Same Excel generation**: Extends existing `excelHelpers.ts` utilities
- **Same authentication**: Uses Clerk auth with multi-tenancy support
- **Same validation**: Extends existing productionStep validation schemas
- **Same UI patterns**: Follows ProductList export button integration

## Excel File Structure (Based on UI Analysis)
- **Column A**: Step Code (stepCode) - Required field
- **Column B**: Step Name (stepName) - Required field  
- **Column C**: Film Sequence (filmSequence) - Optional field
- **Column D**: Step Group (stepGroup) - Optional field
- **Column E**: Created Date (createdAt) - Auto-generated
- **Column F**: Updated Date (updatedAt) - Auto-generated

## Prerequisites
1. Existing `xlsx` library is already available
2. Review existing product export patterns:
   - `src/app/api/products/export/route.ts` - API endpoint pattern
   - `src/hooks/useProductExport.ts` - Hook pattern
   - `src/utils/excelHelpers.ts` - Excel generation utilities
3. Understand ProductionStep structure in `src/types/productionStep.ts`
4. Review existing validation in `src/libs/validations/productionStep.ts`

## Implementation Steps

### Step 1: Extend Excel Helper Functions
**File**: `src/utils/excelHelpers.ts` (extend existing)

**Add ProductionStep-specific functions**:
```typescript
/**
 * Generate Excel workbook from production steps array
 * @param productionSteps - Array of production steps to export
 * @returns Buffer containing Excel file data
 */
export function generateProductionStepsExcel(productionSteps: readonly ProductionStep[]): Buffer {
  // Create a new workbook
  const workbook = XLSX.utils.book_new();

  // Transform production steps data for Excel export
  const excelData = productionSteps.map(step => ({
    'Step Code': step.stepCode,
    'Step Name': step.stepName,
    'Film Sequence': step.filmSequence || '',
    'Step Group': step.stepGroup || '',
    'Created Date': formatDateForExcel(step.createdAt),
    'Updated Date': formatDateForExcel(step.updatedAt),
  }));

  // Create worksheet from data
  const worksheet = XLSX.utils.json_to_sheet(excelData);

  // Set column widths for better readability
  const columnWidths = [
    { wch: 15 }, // Step Code
    { wch: 30 }, // Step Name
    { wch: 15 }, // Film Sequence
    { wch: 20 }, // Step Group
    { wch: 12 }, // Created Date
    { wch: 12 }, // Updated Date
  ];
  worksheet['!cols'] = columnWidths;

  // Add metadata sheet with export information
  const metadataSheet = XLSX.utils.json_to_sheet([
    { Field: 'Export Date', Value: new Date().toISOString() },
    { Field: 'Total Production Steps', Value: productionSteps.length },
    { Field: 'Generated By', Value: 'Yamato SaaS Production Management' },
  ]);

  // Add sheets to workbook
  XLSX.utils.book_append_sheet(workbook, worksheet, 'Production Steps');
  XLSX.utils.book_append_sheet(workbook, metadataSheet, 'Export Info');

  // Generate buffer
  const excelBuffer = XLSX.write(workbook, {
    type: 'buffer',
    bookType: 'xlsx',
    compression: true,
  });

  return excelBuffer;
}

/**
 * Validate ProductionStep export data
 * @param productionSteps - ProductionSteps array to validate
 * @returns Validation result
 */
export function validateProductionStepExportData(productionSteps: readonly ProductionStep[]): {
  isValid: boolean;
  error?: string;
} {
  if (!Array.isArray(productionSteps)) {
    return { isValid: false, error: 'Production steps must be an array' };
  }

  if (productionSteps.length === 0) {
    return { isValid: false, error: 'No production steps to export' };
  }

  if (productionSteps.length > 5000) {
    return { isValid: false, error: 'Too many production steps to export (maximum 5000)' };
  }

  // Check if production steps have required fields
  const invalidSteps = productionSteps.filter(
    step => !step.stepCode || !step.stepName,
  );

  if (invalidSteps.length > 0) {
    return {
      isValid: false,
      error: `${invalidSteps.length} production step(s) missing required fields`,
    };
  }

  return { isValid: true };
}
```

### Step 2: Extend ProductionStep Validation
**File**: `src/libs/validations/productionStep.ts` (extend existing)

**Add export validation schema at the end of file**:
```typescript
// ✅ ProductionStep export validation schema (extends list params but removes pagination)
export const productionStepExportParamsSchema = z.object({
  // ✅ Same search validation as list params
  search: z.union([z.string(), z.undefined(), z.null()])
    .transform((val: string | undefined | null) => val || undefined)
    .pipe(z.string().trim().max(255).optional()),

  // ✅ Same sort validation as list params
  sortBy: z.union([z.string(), z.undefined(), z.null()])
    .transform((val: string | undefined | null) =>
      val && ['createdAt', 'updatedAt', 'stepName', 'stepCode', 'filmSequence'].includes(val) ? val : 'createdAt',
    ),

  sortOrder: z.union([z.string(), z.undefined(), z.null()])
    .transform((val: string | undefined | null) =>
      val && ['asc', 'desc'].includes(val) ? val : 'desc',
    ),
});

// ✅ Type export from export schema
export type ProductionStepExportParams = z.infer<typeof productionStepExportParamsSchema>;

// ✅ Export validation helper function
export function validateProductionStepExportParams(data: unknown): ProductionStepExportParams {
  return productionStepExportParamsSchema.parse(data);
}
```

### Step 3: Create Export API Endpoint
**File**: `src/app/api/production-steps/export/route.ts`

**Implementation (exact copy of products export with ProductionStep adaptations)**:
```typescript
/**
 * Production Steps Export API Route - GET
 * Following TDD Workflow Standards and established API patterns
 * Exports production steps to Excel format respecting search/filter/sort context
 */

import { auth } from '@clerk/nextjs/server';
import type { NextRequest } from 'next/server';
import { ZodError } from 'zod';

import { getPaginatedProductionSteps } from '@/libs/queries/productionStep';
import { validateProductionStepExportParams } from '@/libs/validations/productionStep';
import type { ProductionStepListParamsWithOwner } from '@/types/productionStep';
import { generateExcelFilename, generateProductionStepsExcel, validateProductionStepExportData } from '@/utils/excelHelpers';

export async function GET(request: NextRequest): Promise<Response> {
  try {
    // ✅ CRITICAL: Same auth pattern as main production steps API
    const { userId, orgId } = await auth();

    if (!userId) {
      return Response.json(
        { success: false, error: 'Unauthorized access', code: 'UNAUTHORIZED' },
        { status: 401 },
      );
    }

    // Handle both NextRequest (runtime) and Request (testing)
    const url = new URL(request.url);
    const searchParams = url.searchParams;

    // ✅ CRITICAL: Convert null to undefined (following 400 fix pattern)
    const queryParams = {
      search: searchParams.get('search') || undefined,
      sortBy: searchParams.get('sortBy') || undefined,
      sortOrder: searchParams.get('sortOrder') || undefined,
    };

    // ✅ Validation with proper error handling
    const validatedParams = validateProductionStepExportParams(queryParams);

    // Add ownerId to the validated params for multi-tenancy
    const paramsWithOwner: ProductionStepListParamsWithOwner = {
      // No pagination for export - get all records up to limit
      page: 1,
      limit: 5000, // Maximum export limit
      search: validatedParams.search,
      sortBy: validatedParams.sortBy as ProductionStepListParamsWithOwner['sortBy'],
      sortOrder: validatedParams.sortOrder as ProductionStepListParamsWithOwner['sortOrder'],
      ownerId: orgId || userId,
    };

    // Fetch production steps without pagination limits (up to 5000)
    const result = await getPaginatedProductionSteps(paramsWithOwner);

    // Validate export data
    const validation = validateProductionStepExportData(result.productionSteps);
    if (!validation.isValid) {
      return Response.json(
        { success: false, error: validation.error, code: 'EXPORT_VALIDATION_ERROR' },
        { status: 400 },
      );
    }

    // Generate Excel file
    const excelBuffer = generateProductionStepsExcel(result.productionSteps);
    const filename = generateExcelFilename('production-steps-export');

    // Return file response with proper headers
    return new Response(excelBuffer, {
      headers: {
        'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'Content-Disposition': `attachment; filename="${filename}"`,
        'Content-Length': excelBuffer.length.toString(),
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0',
      },
    });
  } catch (error) {
    console.error('Error exporting production steps:', error);

    if (error instanceof ZodError) {
      return Response.json(
        { success: false, error: 'Invalid parameters', code: 'VALIDATION_ERROR', details: error.errors },
        { status: 400 },
      );
    }

    // Handle Excel generation errors
    if (error instanceof Error && error.message.includes('Excel')) {
      return Response.json(
        { success: false, error: 'Failed to generate Excel file', code: 'EXCEL_GENERATION_ERROR' },
        { status: 500 },
      );
    }

    return Response.json(
      { success: false, error: 'Internal server error', code: 'INTERNAL_ERROR' },
      { status: 500 },
    );
  }
}
```

### Step 4: Create Export Hook
**File**: `src/hooks/useProductionStepExport.ts`

**Implementation (exact copy of useProductExport with ProductionStep adaptations)**:
```typescript
/**
 * useProductionStepExport Hook
 * Manages production step export functionality
 * Following TDD implementation and established hook patterns from useProductExport
 */

import { useCallback, useState } from 'react';

import type { ProductionStepExportParams } from '@/libs/validations/productionStep';

type ExportState = {
  isExporting: boolean;
  exportError: string | null;
  lastExportDate: Date | null;
};

type ExportReturn = ExportState & {
  exportProductionSteps: (params?: ProductionStepExportParams) => Promise<void>;
  clearError: () => void;
};

export function useProductionStepExport(): ExportReturn {
  const [state, setState] = useState<ExportState>({
    isExporting: false,
    exportError: null,
    lastExportDate: null,
  });

  const clearError = useCallback(() => {
    setState(prev => ({ ...prev, exportError: null }));
  }, []);

  const exportProductionSteps = useCallback(async (params?: ProductionStepExportParams): Promise<void> => {
    setState(prev => ({ ...prev, isExporting: true, exportError: null }));

    try {
      // Build query parameters
      const searchParams = new URLSearchParams();

      if (params?.search) {
        searchParams.append('search', params.search);
      }
      if (params?.sortBy) {
        searchParams.append('sortBy', params.sortBy);
      }
      if (params?.sortOrder) {
        searchParams.append('sortOrder', params.sortOrder);
      }

      // Fetch export data
      const response = await fetch(`/api/production-steps/export?${searchParams.toString()}`, {
        method: 'GET',
        headers: {
          Accept: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        },
      });

      if (!response.ok) {
        // Try to get error details from JSON response
        let errorMessage = 'Failed to export production steps';
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorMessage;
        } catch {
          errorMessage = `Export failed with status ${response.status}`;
        }
        throw new Error(errorMessage);
      }

      // Get filename from Content-Disposition header
      const contentDisposition = response.headers.get('Content-Disposition');
      const filenameMatch = contentDisposition?.match(/filename="(.+)"/);
      const filename = filenameMatch?.[1] || `production-steps-export-${Date.now()}.xlsx`;

      // Convert response to blob
      const blob = await response.blob();

      // Trigger file download
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();

      // Cleanup
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      setState(prev => ({
        ...prev,
        isExporting: false,
        exportError: null,
        lastExportDate: new Date(),
      }));
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Failed to export production steps';
      setState(prev => ({
        ...prev,
        isExporting: false,
        exportError: errorMessage,
      }));
      throw error; // Re-throw for component-level error handling
    }
  }, []);

  return {
    ...state,
    exportProductionSteps,
    clearError,
  };
}
```

### Step 5: Integrate Export Button in ProductionStepList
**File**: `src/features/productionStep/ProductionStepList.tsx` (modify existing)

**Add export functionality to existing component**:
```typescript
// Add import at the top
import { Download } from 'lucide-react';
import { useProductionStepExport } from '@/hooks/useProductionStepExport';

// In ProductionStepList component, add export hook
const { exportProductionSteps, isExporting, exportError, clearError } = useProductionStepExport();

// Add export handler
const handleExport = async () => {
  try {
    await exportProductionSteps({
      search,
      sortBy,
      sortOrder,
    });
  } catch (error) {
    // Error is handled by hook
    console.error('Export failed:', error);
  }
};

// In the header controls section (around line 190), add export button:
<div className="flex items-center space-x-4">
  {/* Export Button */}
  <button
    type="button"
    onClick={handleExport}
    disabled={isExporting}
    className="inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
    title="Export production steps to Excel"
  >
    <Download className="mr-2 h-4 w-4" />
    {isExporting ? 'Exporting...' : 'Export to Excel'}
  </button>

  {/* Existing sort controls... */}
</div>

// Add export error display (if needed)
{exportError && (
  <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-md">
    <p className="text-sm text-red-700">{exportError}</p>
    <button
      type="button"
      onClick={clearError}
      className="text-sm text-red-600 underline"
    >
      Dismiss
    </button>
  </div>
)}
```

### Step 6: Create Export Type Definitions (Optional)
**File**: `src/types/productionStepExport.ts` (if needed, or extend existing)

```typescript
// Export-specific types for ProductionStep (if not added to main file)
export interface ProductionStepExportParams {
  search?: string;
  sortBy?: 'createdAt' | 'updatedAt' | 'stepName' | 'stepCode' | 'filmSequence';
  sortOrder?: 'asc' | 'desc';
}

export interface ProductionStepExportResult {
  filename: string;
  recordCount: number;
  exportDate: Date;
}
```

## Files to Create
1. `src/app/api/production-steps/export/route.ts` - Export API endpoint
2. `src/hooks/useProductionStepExport.ts` - Export functionality hook
3. `src/types/productionStepExport.ts` - Export type definitions (optional)

## Files to Modify
1. `src/utils/excelHelpers.ts` - Add ProductionStep Excel generation functions
2. `src/libs/validations/productionStep.ts` - Add export validation schema
3. `src/features/productionStep/ProductionStepList.tsx` - Add export button and integration

## Testing Strategy
1. **Unit Tests**: 
   - Excel generation functions in `src/utils/__tests__/excelHelpers.test.ts`
   - Export hook in `src/hooks/__tests__/useProductionStepExport.test.ts`
2. **API Tests**: 
   - Export endpoint in `src/app/api/production-steps/export/route.test.ts`
   - Authentication, validation, and error scenarios
3. **Integration Tests**: 
   - Complete export workflow
   - UI integration testing
4. **E2E Tests**: 
   - File download functionality
   - Export with various filter combinations

## Performance Considerations
- **Export Limit**: Maximum 5000 production steps per export
- **File Size**: Typical production step data should result in manageable Excel files
- **Memory Usage**: Same patterns as product export for memory efficiency
- **Timeout Handling**: Standard API timeout patterns

## Security Considerations
- **Authentication**: Same Clerk authentication as existing APIs
- **Multi-tenancy**: Proper ownerId isolation (orgId || userId)
- **Input Validation**: Zod validation for all export parameters
- **Rate Limiting**: Consider same rate limiting as product export

## User Experience
- **Button Placement**: Export button in header controls next to search/sort
- **Loading States**: Clear indication during export process
- **Error Handling**: User-friendly error messages with retry options
- **File Download**: Automatic download with meaningful filename
- **Filename Pattern**: `production-steps-export-YYYY-MM-DDTHH-mm-ss.xlsx`

## Success Criteria
- Users can export up to 5000 production steps as Excel file
- Export respects current search/filter/sort context
- File downloads automatically with proper Excel formatting
- Export is properly secured with multi-tenant isolation
- Loading states and error handling work correctly
- Performance is acceptable for reasonable dataset sizes
- Consistent user experience with existing product export
- Zero additional dependencies required

## Implementation Timeline
- **Day 1**: Excel helpers and validation (Step 1 & 2)
- **Day 2**: API endpoint and export hook (Step 3 & 4)  
- **Day 3**: UI integration and testing (Step 5 & 6)
- **Day 4**: Testing and refinement

Total: ~3-4 days (faster than product export due to pattern reuse)